# x402 Payment API

Lochagos exposes a pay-per-call AI insight endpoint via the [x402 protocol](https://x402.org) — an HTTP-native micropayment standard built on Base and USDC.

## Endpoint

```
GET https://lochagos-web.vercel.app/api/x402/insight
```

### Payment Details

| Field      | Value                                        |
|------------|----------------------------------------------|
| Protocol   | x402 (HTTP Payment Protocol)                 |
| Version    | v2                                           |
| Scheme     | `exact` (EIP-3009 / Permit2)                 |
| Network    | Base Mainnet (`eip155:8453`)                 |
| Asset      | USDC (`0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913`) |
| Price      | `$0.001 USDC` per request                    |
| Receiver   | `0xFB4AcF77628774dD5b7db9cad16a0fb12c6EdDea` |
| Facilitator | `https://x402.org/facilitator`              |

---

## How x402 Works

1. **Client sends request** → No payment header included.
2. **Server returns `HTTP 402`** → With a `PAYMENT-REQUIRED` header containing base64-encoded payment requirements.
3. **Client reads requirements** → Decodes and parses the payment requirements.
4. **Client signs payment** → Creates a signed EIP-3009 (or Permit2) authorization for the exact USDC amount.
5. **Client retries with `PAYMENT-SIGNATURE` header** → Includes the base64-encoded signed payment payload.
6. **Server verifies + settles** → Confirms the payment via the x402 facilitator, executes the on-chain transfer, and returns the response with a `PAYMENT-RESPONSE` header.

---

## Quick Start (Node.js)

### Using the x402 client SDK

```typescript
import { createWalletClient, http } from "viem";
import { base } from "viem/chains";
import { privateKeyToAccount } from "viem/accounts";

// Set up your wallet
const account = privateKeyToAccount("0x<YOUR_PRIVATE_KEY>");
const walletClient = createWalletClient({
  account,
  chain: base,
  transport: http("https://mainnet.base.org"),
});

// Wrap fetch with x402 payment handling
import { wrapFetchWithPayment } from "@x402/client";
const payingFetch = wrapFetchWithPayment(fetch, walletClient);

// Just call the endpoint — payment is handled automatically!
const response = await payingFetch(
  "https://lochagos-web.vercel.app/api/x402/insight"
);
const data = await response.json();
console.log(data.insight.title);
console.log(data.insight.body);
```

### Manual flow (curl + custom headers)

```bash
# Step 1: Probe for payment requirements
curl -v https://lochagos-web.vercel.app/api/x402/insight
# → HTTP 402, headers include PAYMENT-REQUIRED: <base64>

# Step 2: Decode the payment requirements
PAYMENT_REQUIRED=$(curl -sI https://lochagos-web.vercel.app/api/x402/insight \
  | grep -i "payment-required" | awk '{print $2}')
echo $PAYMENT_REQUIRED | base64 --decode | python3 -m json.tool

# Step 3: Sign and send the payment (requires x402 client SDK or awal)
# Step 4: Retry with PAYMENT-SIGNATURE header
curl -H "PAYMENT-SIGNATURE: <base64_signed_payload>" \
  https://lochagos-web.vercel.app/api/x402/insight
```

### Using Coinbase awal CLI

```bash
# If awal supports x402 payments natively:
awal pay "https://lochagos-web.vercel.app/api/x402/insight"
```

---

## Response Format

### 402 Payment Required

```
HTTP 402
PAYMENT-REQUIRED: <base64-encoded PaymentRequired object>
Content-Type: application/json
```

Decoded `PAYMENT-REQUIRED` body:
```json
{
  "x402Version": 2,
  "error": "Payment required",
  "resource": {
    "url": "https://lochagos-web.vercel.app/api/x402/insight",
    "description": "Lochagos Premium AI Insight — $0.001 USDC per request",
    "mimeType": "application/json"
  },
  "accepts": [
    {
      "scheme": "exact",
      "network": "eip155:8453",
      "amount": "1000",
      "asset": "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913",
      "payTo": "0xFB4AcF77628774dD5b7db9cad16a0fb12c6EdDea",
      "maxTimeoutSeconds": 300
    }
  ]
}
```

### 200 OK (after payment)

```
HTTP 200
PAYMENT-RESPONSE: <base64-encoded SettleResponse>
Content-Type: application/json
```

```json
{
  "success": true,
  "insight": {
    "title": "Agentic Commerce is Emerging",
    "body": "AI agents are becoming economic participants...",
    "category": "macro_trend",
    "timestamp": "2026-02-20T22:33:00.000Z",
    "source": "Lochagos Intelligence Network",
    "model": "lochagos-v1"
  },
  "payment": {
    "protocol": "x402",
    "version": 2,
    "network": "eip155:8453",
    "amount": "$0.001 USDC",
    "receiver": "0xFB4AcF77628774dD5b7db9cad16a0fb12c6EdDea"
  }
}
```

---

## Implementation

The endpoint is implemented as a Next.js App Router API route using `@x402/next`:

```typescript
// src/app/api/x402/insight/route.ts
import { withX402, x402ResourceServer } from "@x402/next";
import { registerExactEvmScheme } from "@x402/evm/exact/server";

const server = new x402ResourceServer();
registerExactEvmScheme(server);

export const GET = withX402(
  async (request) => NextResponse.json({ insight: "..." }),
  {
    accepts: {
      scheme: "exact",
      network: "eip155:8453",
      payTo: "0xFB4AcF77628774dD5b7db9cad16a0fb12c6EdDea",
      price: "$0.001",
    },
  },
  server,
);
```

---

## Demo

Visit [lochagos-web.vercel.app/x402](https://lochagos-web.vercel.app/x402) for an interactive demo page.

---

## Links

- [x402 Protocol](https://x402.org)
- [x402 GitHub](https://github.com/coinbase/x402)
- [Base Network](https://base.org)
- [Coinbase CDP](https://portal.cdp.coinbase.com)
